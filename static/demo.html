<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blacksky</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'IBM Plex Mono', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      position: sticky;
      top: 0;
      background: #0a0a0a;
      padding: 24px 32px;
      border-bottom: 1px solid #222;
      z-index: 100;
    }

    .header-title {
      font-size: 0.875rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #666;
      cursor: pointer;
      transition: color 0.15s;
    }

    .header-title:hover {
      color: #e0e0e0;
    }

    /* Left Menu Slideout */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 900;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .menu-panel {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: #0a0a0a;
      border-right: 1px solid #222;
      transition: left 0.3s ease;
      z-index: 901;
      display: flex;
      flex-direction: column;
    }

    .menu-panel.active {
      left: 0;
    }

    .menu-header {
      padding: 24px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-title {
      font-size: 0.6875rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #666;
    }

    .menu-close {
      background: none;
      border: 1px solid #333;
      color: #666;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu-close:hover {
      border-color: #e0e0e0;
      color: #e0e0e0;
    }

    .menu-items {
      flex: 1;
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu-item {
      font-size: 1.5rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      color: #888;
      cursor: pointer;
      padding: 16px 0;
      border-bottom: 1px solid #1a1a1a;
      transition: color 0.15s;
    }

    .menu-item:hover {
      color: #e0e0e0;
    }

    .menu-footer {
      padding: 24px;
      border-top: 1px solid #222;
      font-size: 0.6875rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #333;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
      padding: 0 32px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 48px 0 120px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .message {
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .message-label {
      font-size: 0.6875rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #444;
      margin-bottom: 8px;
    }

    .message-text {
      font-size: 0.9375rem;
      line-height: 1.7;
      color: #e0e0e0;
    }

    .message.user .message-text {
      color: #888;
    }

    .message.bot .message-text {
      background: #141414;
      padding: 16px 20px;
      border-radius: 4px;
      border-left: 2px solid #333;
    }

    .message.bot .message-text .list-item {
      display: block;
      padding: 8px 0;
      border-bottom: 1px solid #222;
    }

    .message.bot .message-text .list-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .message.bot .message-text .list-item:first-child {
      padding-top: 0;
    }

    .message-image-wrapper {
      margin-bottom: 24px;
      border: 1px solid #222;
      border-radius: 4px;
      overflow: hidden;
      background: #111;
    }

    .message-image {
      display: block;
      width: 100%;
      height: auto;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .message-image:hover {
      opacity: 1;
    }

    .message-image-meta {
      padding: 12px 16px;
      border-top: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .message-image-category {
      font-size: 0.625rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #555;
      background: #1a1a1a;
      padding: 4px 8px;
      border-radius: 2px;
    }

    .message-image-caption {
      font-size: 0.75rem;
      color: #666;
    }

    .typing-indicator {
      display: inline;
    }

    .typing-indicator::after {
      content: '▊';
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #0a0a0a;
      padding: 16px 32px;
      padding-bottom: max(24px, env(safe-area-inset-bottom));
      border-top: 1px solid #222;
      z-index: 100;
    }

    .input-row {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 0.9375rem;
      line-height: 1.7;
      color: #e0e0e0;
      resize: none;
      min-height: 24px;
      max-height: 200px;
    }

    textarea::placeholder {
      color: #333;
    }

    .send-button {
      background: transparent;
      border: 1px solid #333;
      color: #666;
      padding: 8px 16px;
      font-family: inherit;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s;
    }

    .send-button:hover {
      border-color: #e0e0e0;
      color: #e0e0e0;
    }

    .send-button:disabled {
      border-color: #222;
      color: #333;
      cursor: not-allowed;
    }

    .welcome {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .welcome-text {
      font-size: 0.875rem;
      color: #333;
      letter-spacing: 0.05em;
    }

    .messages::-webkit-scrollbar {
      width: 4px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: #222;
    }

    @media (max-width: 640px) {
      .header, .chat-container {
        padding-left: 20px;
        padding-right: 20px;
      }
      .input-container {
        padding: 12px 20px;
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }
    }

    /* Slideout Panel */
    .slideout-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1000;
    }

    .slideout-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .slideout-panel {
      position: fixed;
      top: 0;
      right: -500px;
      width: 100%;
      max-width: 500px;
      height: 100%;
      background: #0a0a0a;
      border-left: 1px solid #222;
      transition: right 0.3s ease;
      z-index: 1001;
      display: flex;
      flex-direction: column;
    }

    .slideout-panel.active {
      right: 0;
    }

    .slideout-header {
      padding: 20px 24px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slideout-title {
      font-size: 0.6875rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #666;
    }

    .slideout-close {
      background: none;
      border: 1px solid #333;
      color: #666;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slideout-close:hover {
      border-color: #e0e0e0;
      color: #e0e0e0;
    }

    .slideout-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px 24px;
    }

    .slideout-content p {
      margin-bottom: 16px;
      line-height: 1.7;
      font-size: 0.9375rem;
    }

    .slideout-content .section-title {
      color: #888;
      border-bottom: 1px solid #333;
      padding-bottom: 8px;
      margin-bottom: 16px;
      margin-top: 24px;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .slideout-content .section-title:first-child {
      margin-top: 0;
    }

    .slideout-image {
      width: 100%;
      height: auto;
      border-radius: 4px;
      border: 1px solid #222;
      margin-bottom: 24px;
      opacity: 0.9;
    }

    .message-image-wrapper {
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .message-image-wrapper:hover {
      border-color: #444;
    }

    .inline-link {
      color: #888;
      border-bottom: 1px solid #444;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }

    .inline-link:hover {
      color: #e0e0e0;
      border-color: #e0e0e0;
    }

    @media (max-width: 640px) {
      .slideout-panel {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title" id="menuToggleTitle">Blacksky</div>
  </div>

  <!-- Left Menu Panel -->
  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="menu-panel" id="menuPanel">
    <div class="menu-header">
      <span class="menu-title">Blacksky is ...</span>
      <button class="menu-close" id="menuClose">×</button>
    </div>
    <div class="menu-items">
      <div class="menu-item" data-panel-key="who">WHO</div>
      <div class="menu-item" data-panel-key="what">WHAT</div>
      <div class="menu-item" data-panel-key="why">WHY</div>
    </div>
    <div class="menu-footer">Blacksky LLC © 2025</div>
  </div>

  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="message bot" style="flex:1;display:flex;align-items:center;justify-content:center;">
        <div class="message-text" style="background:none;border:none;padding:0;text-align:center;">
          <p style="font-size:1.5rem;color:#666;margin:0;">... hello world ...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="input-container">
    <div class="input-row">
      <textarea
        id="input"
        rows="1"
        placeholder="> Enter query"
      ></textarea>
      <button class="send-button" id="send">Send</button>
    </div>
  </div>

  <!-- Slideout Panel -->
  <div class="slideout-overlay" id="slideoutOverlay"></div>
  <div class="slideout-panel" id="slideoutPanel">
    <div class="slideout-header">
      <span class="slideout-title" id="slideoutTitle">Details</span>
      <button class="slideout-close" id="slideoutClose">×</button>
    </div>
    <div class="slideout-content" id="slideoutContent">
    </div>
  </div>

  <script src="/static/panels.js"></script>
  <script>
    const API_HOST = window.location.origin;
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    let isLoading = false;
    let hasMessages = true;
    let conversationMessages = []; // Track messages for saving
    let lastActivityTime = Date.now();
    const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes

    // User verification state
    let pendingMatches = null; // Potential user matches waiting for verification
    let awaitingVerification = false; // Are we waiting for user to confirm identity?

    // Cookie utilities
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Get or create user ID
    let userId = getCookie('blacksky_user_id');
    if (!userId) {
      userId = generateUUID();
      setCookie('blacksky_user_id', userId, 30); // 30 day expiry
    }

    // Save conversation on page unload or inactivity
    async function saveConversation() {
      if (conversationMessages.length === 0) return;

      try {
        await fetch(`${API_HOST}/conversation/end`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            messages: conversationMessages
          }),
          keepalive: true // Ensure request completes even if page unloads
        });
      } catch (e) {
        console.error('Failed to save conversation:', e);
      }
    }

    // Handle page unload
    window.addEventListener('beforeunload', saveConversation);

    // Check for inactivity
    setInterval(() => {
      if (conversationMessages.length > 0 && Date.now() - lastActivityTime > INACTIVITY_TIMEOUT) {
        saveConversation();
        conversationMessages = []; // Reset after saving
      }
    }, 60000); // Check every minute

    // Detect if user message contains a name (after Maurice asked)
    function extractNameFromMessage(text) {
      const patterns = [
        /(?:my name is|i'm|i am|call me|this is)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/i,
        /^([A-Z][a-z]+)(?:\s+here)?[.!]?$/i
      ];
      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1].length >= 2 && match[1].length <= 30) {
          return match[1].trim();
        }
      }
      return null;
    }

    // Check if user is confirming their identity
    function isConfirmation(text) {
      const confirmations = ['yes', 'yeah', 'yep', 'yup', 'that\'s me', 'thats me', 'correct', 'right', 'exactly', 'sure'];
      return confirmations.some(c => text.toLowerCase().includes(c));
    }

    // Look up user by name
    async function lookupUserByName(name) {
      try {
        const res = await fetch(`${API_HOST}/user/lookup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        console.error('User lookup failed:', e);
        return null;
      }
    }

    // Link current session to existing user
    async function linkToUser(targetUserId) {
      try {
        const res = await fetch(`${API_HOST}/user/link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            current_user_id: userId,
            target_user_id: targetUserId
          })
        });
        if (res.ok) {
          const data = await res.json();
          // Update our userId to the linked user
          userId = data.new_user_id;
          setCookie('blacksky_user_id', userId, 30);
          console.log('Session linked to existing user:', userId);
          return true;
        }
      } catch (e) {
        console.error('User link failed:', e);
      }
      return false;
    }

    function getImageForTopic(text) {
      const lower = text.toLowerCase();
      
      // Define panel content for each topic
      const panels = {
        treasury: {
          title: 'Treasury Project',
          content: `
            <div class="section-title">› Project Overview</div>
            <p>Blacksky architected and executed migration of 6 mission-critical SharePoint sites to a unified Drupal 8 platform for treasury.gov, consolidating fragmented content systems into a cohesive digital ecosystem.</p>
            
            <div class="section-title">› Key Accomplishments</div>
            <p>Designed enterprise content architecture supporting treasury.gov and 5 subsidiary sites, used by 200+ content creators.</p>
            <p>Built custom migration framework successfully migrating 15,000+ documents and pages with 98% content fidelity.</p>
            <p>Reduced deployment time from 3 days to 4 hours through CI/CD pipeline improvements.</p>
            
            <div class="section-title">› Technologies</div>
            <p>Drupal 8, PHP, XML processing, Acquia Cloud, custom ETL tools</p>
          `
        },
        nih: {
          title: 'NIH Project',
          content: `
            <div class="section-title">› Project Overview</div>
            <p>Blacksky architected a migration from Drupal 8 to Drupal 10 for the National Institute of Nursing Research, requiring federal security clearance and compliance with strict government security protocols.</p>
            
            <div class="section-title">› Key Accomplishments</div>
            <p>Designed FISMA-compliant architecture meeting NIH security standards and federal data protection requirements.</p>
            <p>Architected custom integration layer connecting NIH research databases with public-facing website.</p>
            <p>Implemented Apache Solr search infrastructure enabling complex research publication queries.</p>
            
            <div class="section-title">› Security</div>
            <p>NIH background check and facility badge required.</p>
          `
        },
        fda: {
          title: 'FDA Project',
          content: `
            <div class="section-title">› Project Overview</div>
            <p>Blacksky contributed to FDA platform enhancements supporting regulatory requirements through Phase2.</p>
            
            <div class="section-title">› Technologies</div>
            <p>Drupal 9, PHP, Acquia Cloud, Docker</p>
          `
        },
        usda: {
          title: 'USDA FSIS Project',
          content: `
            <div class="section-title">› Project Overview</div>
            <p>Blacksky led the architectural design and implementation of an enterprise-scale Drupal 10 platform modernization for the USDA Food Safety and Inspection Service, focusing on high-availability infrastructure and AI-powered content services.</p>
            
            <div class="section-title">› Key Accomplishments</div>
            <p>Designed and implemented Redis Cluster architecture on Azure Kubernetes Service, improving application response times by 70%.</p>
            <p>Architected AI-powered translation service enabling real-time multilingual content delivery across 15+ languages.</p>
            <p>Established Kubernetes deployment pipeline with automated scaling, reducing infrastructure costs by 40%.</p>
            
            <div class="section-title">› Technologies</div>
            <p>Drupal 10, PHP, Kubernetes, Redis Cluster, Azure Cloud, Apache Solr, AI integration</p>
          `
        },
        vanguard: {
          title: 'Vanguard Project',
          content: `
            <div class="section-title">› Project Overview</div>
            <p>Blacksky led technical transformation from monolithic Drupal 8 to headless architecture, decoupling content management from presentation layer for multi-channel content delivery.</p>
            
            <div class="section-title">› Key Accomplishments</div>
            <p>Designed and implemented RESTful API layer serving content to Angular frontend.</p>
            <p>Architected content export system reducing API response times by 40%.</p>
            <p>Led Drupal 8 to 9 upgrade while simultaneously implementing headless architecture without service interruption.</p>
            
            <div class="section-title">› Technologies</div>
            <p>Drupal 9, PHP, RESTful APIs, JSON, Angular, Acquia Cloud, AWS, PHPUnit</p>
          `
        },
        mastercard: {
          title: 'Mastercard Project',
          content: `
            <img src="/static/images/mastercard.png" alt="Mastercard" class="slideout-image" onerror="this.style.display='none'">
            <div class="section-title">› Project Overview</div>
            <p>Blacksky built a custom bulk upload system for Mastercard enabling efficient file processing and content management.</p>
            
            <div class="section-title">› Key Accomplishments</div>
            <p>Built custom Drupal 9 module enabling bulk upload of hundreds of files with automated validation.</p>
            <p>Designed file processing pipeline including unzip functionality, naming convention verification, and automated node creation.</p>
            
            <div class="section-title">› Technologies</div>
            <p>Drupal 9, PHP, Acquia Cloud, Docker</p>
          `
        },
        mission: {
          title: 'Our Mission',
          content: `
            <div class="section-title">› What We Believe</div>
            <p>Blacksky believes technology should empower people, not just corporations.</p>
            <p>While we build AI solutions for enterprises and federal agencies, our deeper mission is using technology to strengthen democracy and civic participation.</p>
            
            <div class="section-title">› Civic Technology</div>
            <p>Our flagship project, Poly Sci Fi, reflects this commitment—a platform designed not for political division, but for accountability, giving everyday citizens the tools to engage meaningfully with their elected officials.</p>
            
            <div class="section-title">› Our Values</div>
            <p>We believe that the same AI capabilities transforming business can transform civic life: making government more transparent, participation more accessible, and democracy more responsive.</p>
            <p>Technology is never neutral—we choose to build tools that make society more equitable, informed, and engaged.</p>
          `
        },
        about: {
          title: 'About Blacksky',
          content: `
            <div class="section-title">› Origin</div>
            <p>Blacksky started the way most good things do—with curiosity and a blinking cursor. Before there were bootcamps or YouTube tutorials, there was a kid in an 8th grade computer lab, teaching himself to code on an Apple IIe. That obsession never faded. It just evolved.</p>
            <p>Eighteen years ago, that curiosity became a company. Blacksky LLC was founded on a simple premise: technology is craft.</p>
            
            <div class="section-title">› What We Do</div>
            <p>We architect enterprise platforms for organizations where failure isn't an option. Federal agencies like Treasury, NIH, FDA, and DOT. Fortune 500 companies like Vanguard and Mastercard.</p>
            
            <div class="section-title">› The Name</div>
            <p>Blacksky. It's the moment before dawn. The blank terminal waiting for input. The darkness that makes stars visible. It's potential—quiet, vast, and ready.</p>
          `
        }
      };
      
      // Federal agencies
      if (lower.includes('treasury')) return { src: '/static/images/treasury.png', alt: 'U.S. Department of Treasury', category: 'Federal Agency', panel: panels.treasury };
      if (lower.includes('nih') || lower.includes('national institute of health')) return { src: '/static/images/nih.png', alt: 'National Institutes of Health', category: 'Federal Agency', panel: panels.nih };
      if (lower.includes('fda')) return { src: '/static/images/fda.png', alt: 'Food & Drug Administration', category: 'Federal Agency', panel: panels.fda };
      if (lower.includes('usda') || lower.includes('fsis') || lower.includes('food safety')) return { src: '/static/images/usda.png', alt: 'USDA Food Safety', category: 'Federal Agency', panel: panels.usda };
      if (lower.includes('dot') || lower.includes('transportation')) return { src: '/static/images/dot.png', alt: 'Department of Transportation', category: 'Federal Agency', panel: null };
      if (lower.includes('sec') || lower.includes('securities')) return { src: '/static/images/sec.png', alt: 'Securities & Exchange Commission', category: 'Federal Agency', panel: null };
      if (lower.includes('hhs') || lower.includes('health and human')) return { src: '/static/images/hhs.png', alt: 'Health & Human Services', category: 'Federal Agency', panel: null };
      if (lower.includes('usaid')) return { src: '/static/images/usaid.png', alt: 'USAID', category: 'Federal Agency', panel: null };
      
      // Companies
      if (lower.includes('vanguard')) return { src: '/static/images/vanguard.png', alt: 'Vanguard', category: 'Enterprise Client', panel: panels.vanguard };
      if (lower.includes('mastercard')) return { src: '/static/images/mastercard.png', alt: 'Mastercard', category: 'Enterprise Client', panel: panels.mastercard };
      if (lower.includes('blue cross') || lower.includes('bcbs')) return { src: '/static/images/bcbs.png', alt: 'Blue Cross Blue Shield', category: 'Enterprise Client', panel: null };
      if (lower.includes('world bank')) return { src: '/static/images/worldbank.png', alt: 'World Bank', category: 'International', panel: null };
      if (lower.includes('billboard')) return { src: '/static/images/billboard.png', alt: 'Billboard', category: 'Media', panel: null };
      if (lower.includes('national gallery') || lower.includes('art gallery')) return { src: '/static/images/nga.png', alt: 'National Gallery of Art', category: 'Cultural Institution', panel: null };
      
      // Technologies
      if (lower.includes('drupal')) return { src: '/static/images/drupal.png', alt: 'Drupal', category: 'Technology', panel: null };
      if (lower.includes('kubernetes') || lower.includes('k8s')) return { src: '/static/images/kubernetes.png', alt: 'Kubernetes', category: 'Technology', panel: null };
      if (lower.includes('azure')) return { src: '/static/images/azure.png', alt: 'Microsoft Azure', category: 'Cloud Platform', panel: null };
      if (lower.includes('aws') || lower.includes('amazon web')) return { src: '/static/images/aws.png', alt: 'Amazon Web Services', category: 'Cloud Platform', panel: null };
      
      return null;
    }

    function formatMessage(text) {
      // Strip markdown bold **text** and __text__
      text = text.replace(/\*\*(.+?)\*\*/g, '$1');
      text = text.replace(/__(.+?)__/g, '$1');
      
      // Strip markdown italic *text* and _text_
      text = text.replace(/\*(.+?)\*/g, '$1');
      text = text.replace(/_(.+?)_/g, '$1');

      // Split into lines
      let lines = text.split('\n');
      let formatted = [];
      let inList = false;
      let listItems = [];

      for (let line of lines) {
        // Check if line is a list item
        if (line.trim().match(/^[-•›]\s+/) || line.trim().match(/^\d+\.\s+/)) {
          // Clean the bullet/number
          let content = line.trim().replace(/^[-•›]\s+/, '').replace(/^\d+\.\s+/, '');
          listItems.push(content);
          inList = true;
        } else {
          // If we were in a list, close it
          if (inList && listItems.length > 0) {
            let listHtml = listItems.map(item => `<span class="list-item">› ${item}</span>`).join('');
            formatted.push(listHtml);
            listItems = [];
            inList = false;
          }
          // Add regular line
          if (line.trim()) {
            formatted.push(line);
          }
        }
      }

      // Handle any remaining list items
      if (listItems.length > 0) {
        let listHtml = listItems.map(item => `<span class="list-item">› ${item}</span>`).join('');
        formatted.push(listHtml);
      }

      return formatted.join('<br><br>');
    }

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      
      const label = sender === 'bot' ? 'Blacksky' : 'You';
      const content = sender === 'bot' 
        ? formatMessage(text) 
        : text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
      
      // Check for relevant image
      let imageHtml = '';
      if (sender === 'bot') {
        const image = getImageForTopic(text);
        if (image) {
          // Use encodeURIComponent for unicode-safe encoding
          const clickable = image.panel ? 'data-panel="' + encodeURIComponent(JSON.stringify(image.panel)) + '"' : '';
          const clickClass = image.panel ? 'clickable' : '';
          imageHtml = `
            <div class="message-image-wrapper ${clickClass}" ${clickable}>
              <img src="${image.src}" alt="${image.alt}" class="message-image" onerror="this.parentElement.style.display='none'">
              <div class="message-image-meta">
                <span class="message-image-category">${image.category}</span>
                <span class="message-image-caption">${image.alt}${image.panel ? ' ›' : ''}</span>
              </div>
            </div>
          `;
        }
      }
      
      div.innerHTML = `
        <div class="message-label">${label}</div>
        <div class="message-text">${imageHtml}${content}</div>
      `;
      
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function showTyping() {
      const div = document.createElement('div');
      div.className = 'message bot';
      div.id = 'typing';
      div.innerHTML = `
        <div class="message-label">Blacksky</div>
        <div class="message-text"><span class="typing-indicator"></span></div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }

    function autoResize() {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text || isLoading) return;

      addMessage(text, 'user');
      input.value = '';
      autoResize();

      // Track message and update activity
      conversationMessages.push({ role: 'user', content: text });
      lastActivityTime = Date.now();

      // Check if user is confirming their identity
      if (awaitingVerification && pendingMatches && pendingMatches.length > 0) {
        if (isConfirmation(text)) {
          // User confirmed - link to the first match
          await linkToUser(pendingMatches[0].user_id);
        }
        // Reset verification state either way
        awaitingVerification = false;
        pendingMatches = null;
      }

      // Check if user just provided their name
      const extractedName = extractNameFromMessage(text);
      let matchesContext = null;

      if (extractedName) {
        const lookup = await lookupUserByName(extractedName);
        if (lookup && lookup.count > 0) {
          pendingMatches = lookup.matches;
          awaitingVerification = true;
          // Build context for Maurice to ask verification question
          matchesContext = lookup.matches.map(m => ({
            name: m.name,
            last_topic: m.last_topic || 'general questions'
          }));
        }
      }

      isLoading = true;
      sendBtn.disabled = true;
      showTyping();

      try {
        // Build request body
        const requestBody = { message: text, user_id: userId };

        // Add potential matches for Maurice to verify
        if (matchesContext) {
          requestBody.potential_matches = matchesContext;
        }

        const res = await fetch(`${API_HOST}/chat/stream`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        hideTyping();
        
        // Create bot message container for streaming
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        messageDiv.innerHTML = `
          <div class="message-label">Maurice</div>
          <div class="message-text"></div>
        `;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
        
        const textDiv = messageDiv.querySelector('.message-text');
        let fullResponse = '';
        
        // Read the stream
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') {
                break;
              }
              try {
                const parsed = JSON.parse(data);
                if (parsed.token) {
                  fullResponse += parsed.token;
                  textDiv.innerHTML = formatResponse(fullResponse);
                  messages.scrollTop = messages.scrollHeight;
                }
                if (parsed.error) {
                  throw new Error(parsed.error);
                }
              } catch (e) {
                // Skip malformed JSON
              }
            }
          }
        }

        // Track bot response
        if (fullResponse) {
          conversationMessages.push({ role: 'assistant', content: fullResponse });
        }

        // Check for images after streaming completes
        const image = getImageForTopic(fullResponse);
        if (image) {
          const clickable = image.panel ? 'data-panel="' + encodeURIComponent(JSON.stringify(image.panel)) + '"' : '';
          const clickClass = image.panel ? 'clickable' : '';
          const imageHtml = `
            <div class="message-image-wrapper ${clickClass}" ${clickable}>
              <img src="${image.src}" alt="${image.alt}" class="message-image" onerror="this.parentElement.style.display='none'">
              <div class="message-image-meta">
                <span class="message-image-category">${image.category}</span>
                <span class="message-image-caption">${image.alt}${image.panel ? ' ›' : ''}</span>
              </div>
            </div>
          `;
          textDiv.insertAdjacentHTML('afterend', imageHtml);
        }
        
      } catch (err) {
        console.error('Stream error:', err);
        hideTyping();
        addMessage("Sorry, there are a lot of people talking in my ear at once. Try again in a moment?", 'bot');
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        input.focus();
      }
    }
    
    // Format response text (convert newlines, etc.)
    function formatResponse(text) {
      return text
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>');
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('input', autoResize);
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    input.focus();

    // Slideout panel functionality
    const slideoutOverlay = document.getElementById('slideoutOverlay');
    const slideoutPanel = document.getElementById('slideoutPanel');
    const slideoutTitle = document.getElementById('slideoutTitle');
    const slideoutContent = document.getElementById('slideoutContent');
    const slideoutClose = document.getElementById('slideoutClose');

    function openPanel(panelData) {
      slideoutTitle.textContent = panelData.title;
      slideoutContent.innerHTML = panelData.content;
      slideoutOverlay.classList.add('active');
      slideoutPanel.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePanel() {
      slideoutOverlay.classList.remove('active');
      slideoutPanel.classList.remove('active');
      document.body.style.overflow = '';
    }

    slideoutClose.addEventListener('click', closePanel);
    slideoutOverlay.addEventListener('click', closePanel);

    // Handle clicks on images with panels
    document.addEventListener('click', (e) => {
      const wrapper = e.target.closest('.message-image-wrapper.clickable');
      if (wrapper && wrapper.dataset.panel) {
        const panelData = JSON.parse(decodeURIComponent(wrapper.dataset.panel));
        openPanel(panelData);
      }
      
      // Handle inline text links
      const inlineLink = e.target.closest('.inline-link');
      if (inlineLink && inlineLink.dataset.panelKey) {
        const key = inlineLink.dataset.panelKey;
        const panels = getPanels();
        if (panels[key]) {
          openPanel(panels[key]);
        }
      }
    });

    // Panels now loaded from /static/panels.js and /static/panels.json

    // Left menu functionality
    const menuToggleTitle = document.getElementById('menuToggleTitle');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuPanel = document.getElementById('menuPanel');
    const menuClose = document.getElementById('menuClose');
    const menuItems = document.querySelectorAll('.menu-item');

    function openMenu() {
      menuOverlay.classList.add('active');
      menuPanel.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      menuOverlay.classList.remove('active');
      menuPanel.classList.remove('active');
      if (!slideoutPanel.classList.contains('active')) {
        document.body.style.overflow = '';
      }
    }

    menuToggleTitle.addEventListener('click', openMenu);
    menuClose.addEventListener('click', closeMenu);
    menuOverlay.addEventListener('click', closeMenu);

    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        const key = item.dataset.panelKey;
        const panels = getPanels();
        if (panels[key]) {
          closeMenu();
          setTimeout(() => openPanel(panels[key]), 150);
        }
      });
    });

    // Close panel with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePanel();
    });
  </script>
</body>
</html>
